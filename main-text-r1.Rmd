---
title: "Woody Biomass Stocks and Fluxes in the Barro Colorado Island 50 ha Plot"
author: Camille Piponiot; Helene C. Muller-Landau

institute:
  - fs: Cirad, Université de Montpellier, UR Forests and Societies, 34980 Montferrier-sur-Lez, France
  - stri: Forest Global Earth Observatory, Smithsonian Tropical Research Institute, Apartado Postal 0843-03092, Panamá, Republic of Panamá

output: 
  bookdown::word_document2:
    reference_docx: common/word-styles-ref-01.docx
    number_sections: false
  fig_caption: yes
bibliography: common/bibliography.bib
csl: common/smithsonian-institution-scholarly-press.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, results = "hide", tinytex.clean = FALSE)

# load packages
library(ggplot2)
library(data.table)

# load data
load("cache.rda")
# bci habitats from Harms et al 2001
load("bci_habitat.rda")
```

**Corresponding author**: Camille Piponiot, camille.piponiot-laroche@cirad.fr  

**Word count** (not including abstract, section titles and figure legends): about 3900

4 figures, 0 tables 

**Keywords** (up to 10): aboveground biomass; woody productivity; tropical forest; carbon; Barro Colorado Island; permanent forest plot; tree census

**Abstract (max 150 words)**: Tropical forest biomass, and the carbon it contains, is of increasing interest to the international community, particularly for its role in climate change. The 50 ha forest plot on Barro Colorado Island provides an excellent resource for investigating changes in tropical forest biomass and hypothesized mechanisms due to its size, temporal extent (1982 to present), and sampling intensity (all trees larger than 1 cm diameter). These census data, together with tree biomass allometric equations, enable calculation of estimated aboveground woody biomass and woody productivity of trees. In this chapter, we first briefly describe the methods used to calculate aboveground biomass and woody productivity, including challenges associated with buttressed trees and differences in census methods over time. We then present and review findings on aboveground biomass and woody productivity, including their spatial variation with habitat, their temporal variation, and their distribution among trees of different size classes and functional groups.


## Introduction 

Tropical forests constitute a globally important carbon stock, and uncertainty about the future of this carbon is one of the largest sources of uncertainty in projecting the future global carbon cycle [@Cavaleri2015]. Tree trunks and branches account for the large majority of forest biomass carbon stocks, as dry wood is approximately half carbon by weight [@Thomas2012]. The trajectory of tropical forest biomass carbon stocks thus depends on whether the total mass of wood in tropical forests increases or decreases, which in turn depends on land use as well as on how tree growth and mortality respond to changing atmospheric composition and climate [@Mitchard2018]. It is well-understood that deforestation and forest degradation result in the release of carbon previously stored in biomass to the atmosphere as biomass burns and/or decomposes, whereas reforestation and forest regrowth result in carbon uptake. What is less clear is how increasing atmospheric carbon dioxide and changing climate is affecting carbon stocks in intact and otherwise undisturbed forests.

Carbon stocks per area in intact forests depend on the balance of two carbon fluxes: carbon uptake associated with tree growth, and carbon loss associated with tree mortality and branchfall, and both these fluxes can be influenced by global change [@Muller-Landau2021]. Increasing atmospheric carbon dioxide concentrations and increasing nitrogen deposition may increase photosynthetic rates, and thus potentially tree growth fluxes and forest carbon stocks [@Norby2005;@QuinnThomas2010]. At the same time, changing climates are increasing the frequency and intensity of droughts and major storms, and these and other factors may be increasing tropical tree mortality rates, thereby decreasing forest carbon stocks [@McDowell2018].

The Barro Colorado Island (BCI) 50-ha plot was installed in 1980 to study forest composition and dynamics, and complete inventories of all stems larger than 1 cm in diameter have been conducted every 5 years since then. These data are complemented by large data sets on tree height and wood density collected in Central Panama. Together, these data can be used to quantify the aboveground biomass of each tree measured. The BCI 50-ha plot is therefore an exceptional resource for studying the spatial and temporal variation in carbon stocks and fluxes.  The temporal coverage of forest inventories (35 years and growing) provides insight into long-term changes in biomass dynamics; the plot’s large size limits sampling errors that can occur with smaller plots; and measurements of all trees from a small diameter upwards provide crucial information on understory carbon dynamics. 

In this chapter we review previous research on woody biomass on the BCI 50 ha plot, including methodological studies as well as patterns of variation in woody biomass stocks and fluxes across space, time, tree size and functional group. We also present updated figures and tables of these results, and the associated supplemental material provides complete associated R code and additional information on the sensitivity of the results to methodological details. Other chapters address soil carbon stocks and fluxes [@Cusack2023], woody debris carbon stocks and fluxes [@Gora2023], and remote sensing of forest structure and dynamics including biomass stocks and fluxes [@Cusack2023].

## Background

Aboveground biomass (AGB) can be measured directly by harvesting, drying, and weighing the trees. Such destructive methods are expensive, preclude remeasurement over time in the same site, and have never been applied on BCI where destructive sampling is prohibited. Aboveground biomass is thus more commonly inferred by applying allometric equations fitted to a limited amount of destructive harvest data. These allometric equations enable estimation of the biomass of individual trees from their diameters, and sometimes their heights and species wood densities. The estimated aboveground biomass is then summed across all trees to obtain the total aboveground biomass of the stand. This is often further converted to carbon stocks by multiplying by a conversion factor representing the proportion of dry biomass that is carbon which is commonly taken to be a fixed value, although in reality it varies among species. Wood carbon fractions for 59 Panamanian tree species averaged 45.0% (range 42-48%) for oven-dried samples and 47.4% (range 42-52%) for freeze-dried samples that capture the volatile fraction [@Thomas2012], compared with an average of 45.6% for 1187 tropical angiosperms [@Martin2018].  

Estimating the biomass of an individual tree from allometric equations is not a trivial task, as it requires many choices and approximations. Early allometric equations were calibrated with only on a few harvested trees, usually at few sites, and used only diameter as a predictor variable [e.g. in @Chave2003]. Later equations include a larger number of sites spread across the tropics, incorporate tree height, or environmental factors that affect height, and species-level wood specific gravity [@Chave2005;@Chave2014]. Tree height is more difficult to measure than diameter, especially in dense vegetation: for sites such as BCI where heights of all trees are not available, then a height-diameter allometry equation can be chosen [e.g., @MartinezCano2019 for BCI]. Wood specific gravity is most often assigned by species from large taxonomic databases [e.g., @Zanne2009], and extensive wood specific gravity data collected in central Panama can be used in allometric equations at BCI [Supplementary material in @Rutishauser2020; @Condit2019 species list].

In addition to biomass stocks, ecologists are also interested in biomass fluxes due to wood production and tree mortality, as well as their difference, which represents the net change in biomass over time. Aboveground woody productivity can be simply calculated by summing the increase in biomass of living trees between two censuses and the biomass of recruited trees (i.e., trees that were measured for the first time in the later census), and dividing by the total area and by the length of the time interval between the two censuses. Aboveground woody mortality is most simply calculated by summing the biomass of all trees that died between two censuses, and again dividing by total area and time interval. These simple calculations underestimate the total flux of mass per area per time because they miss productivity of trees that died during the census interval, a bias that can be overcome by the use of more complicated equations [@Kohyama2019]. 

Ratios of these quantities are also of interest. The biomass mortality rate is the mortality flux divided by the biomass stock. Relative woody productivity can be calculated as the productivity flux divided by the biomass stock. In old-growth forests such as this one, the woody residence time, or average lifetime of biomass in the plot, can be estimated as biomass stock divided by productivity flux, or biomass stock divided by mortality flux [@Muller-Landau2021].  

## Methodological studies 

@Chave2004 presented one of the first studies estimating the contributions of different factors to uncertainty in biomass estimates, using the BCI 50 ha plot as a case study.  They quantified uncertainty due to tree measurement error, choice of allometric model, sampling error associated with plot size, and representativeness of the larger forest landscape. Tree measurement errors can be exceptionally well-quantified for BCI using double-blind remeasurements of 1715 trees. @Chave2004 estimated that the error associated with allometric models was the most important source of error in aboveground biomass at the plot level, around 13% of the mean AGB estimate. Subsequent studies have expanded on this pioneering work, and the BIOMASS package in R now includes tools for estimating and propagating these sources of uncertainty, including the BCI tree remeasurement data as an example [@Rejou-Mechain2017]. These studies all find that estimates of plot biomass stocks and fluxes depend strongly on the allometric equations and parameters that are chosen [@Chave2003; @Chave2004; Figure S1a, Table S1]. 

Studies on the BCI 50-ha plot have also developed methods for improved methods of estimating biomass stocks and fluxes for trees with nonstandard diameter measurement heights and changes in measurement heights over time.  The standard height for measuring tree diameter is 1.3 m (referred to as diameter at breast height, or DBH), but trees with trunk irregularities at 1.3 m are typically measured at another point, and buttressed trees are measured above the tops of buttresses [@Condit1998]. For these trees, diameter measurement height often varies among censuses, as buttresses grow upwards over time and deformities and irregularities change over time. Because tree trunks decrease in diameter with height (i.e., they taper), this creates challenges for correctly estimating diameter and biomass growth of individual trees [@Sheil1995]. Further, this can lead to biases in plot-level estimates of biomass change when there are systematic differences in measurement height methods among censuses, as on the BCI 50 ha plot, where the proportion of trees measured at higher points increased over time, especially from the early censuses [@Muller-Landau2014]. @Cushman2014 measured trunk taper above buttresses on hundreds of trees on BCI and developed a taper correction equation that can be used to estimate equivalent diameter at 1.3 m height from measurements at nonstandard heights. Applying this correction avoids bias from changing measurement heights; for BCI, uncorrected data show a decrease in biomass of 0.21% yr$^{-1}$ between 1985 and 2010, whereas taper-corrected data showed an increase of 0.18% yr$^{-1}$ [@Cushman2014]. @Cushman2021 expanded on this work, quantifying trunk taper at multiple sites and developing generalized equations for taper correction in tropical forests. @Muller-Landau2014 also explored the effects of alternative outlier detection and correction procedures for estimates of biomass change, showing that multiple reasonable alternative procedures can result in very different estimates.  

For the Barro Colorado Nature Monument (BCNM), we currently recommend use of the @Chave2014 pantropical equation including height in combination with the generalized local height allometry of @MartinezCano2019. This produces an AGB estimate for 2015 of 236 Mg/ha (Figure \@ref(fig:temporal)a; Table S1). The @Chave2014 allometric equation is based on the largest existing dataset of harvested trees (4004, including 1481 with height), and is widely used in tropical studies, simplifying comparison of biomass values across studies and sites. The use of a local height allometry [@MartinezCano2019] ensures that the allometry is adapted to local environmental conditions in the BCNM. In contrast, the use of the @Chave2014 allometry without height results in a 10% higher value, likely overestimating biomass at BCI. For comparisons over time within the BCI 50 ha plot that include censuses before 1995, we recommend use of the taper correction to avoid biases due to changes in the distribution of measurement heights across censuses. For comparing BCI with other sites, especially if only using data from 1995 and after, we recommend not using the taper correction unless it can be applied across all sites.  For comparisons of variation in biomass stocks and fluxes at many sites across the regional rainfall gradient for which local height data are not available [e.g., @Muller-Landau2023], we recommend the use of the @Chave2014 pantropical equation without height, as its environmental factor implicitly captures climate-related variation in height allometries. We note that the preferred allometric equations are expected to change in the future as equations incorporating more data and more regional data become available.  Many additional biomass allometry studies have been published since @Chave2014, including @Duque2017, which is based on 392 trees harvested in the Pacific coast of Colombia, an area with similar floristics and forest structure to the BCI 50-ha plot.    

## Empirical Patterns

### Spatial variation

Woody biomass stocks and fluxes exhibit high small-scale spatial variability [e.g., tens of meters; @Rejou-Mechain2014]. This is especially true when all stocks and fluxes for a tree are assigned to the location of the trunk, as is typical in such analyses; the noisiness decreases when they are instead distributed across the estimated crown area [@Mascaro2011a]. Because forest inventories are expensive and therefore limited in area (typically 0.1-1 ha), this fine-scale variability results in sampling errors.  These can be well-quantified on large plots like the BCI 50-ha plot by quantifying the spatial variation within the plot. @Chave2003 calculated that estimating the total plot’s aboveground biomass within a 20% error with 95% confidence would require 481 subplots of 10 x10 m (4.81 ha total), 160 of 20 x 20 m (6.4 ha total), or nine of 100 x 100 m (9 ha total). A single 1-ha subplot is within 10% of the meal value of the plot as a whole only 40% of the time [@Hetzer2020].  In general, the standard deviation (SD) of variation among subplots declines with increasing area as approximately SD~1/sqrt(area), for both biomass [@Chave2003;@Rejou-Mechain2014] and biomass change [@Muller-Landau2014], as expected for independent samples, but with deviations indicative of spatial autocorrelation in biomass as subplot size exceeds 1 ha [@Rejou-Mechain2014].  Variograms and wavelet variance analyses detect no statistically significant local spatial autocorrelation of biomass or biomass change within the BCI 50-ha plot for subplots of 5x5 to 100x100 m [@Muller-Landau2014;@Rejou-Mechain2014], supporting the treatment of subplots as independent samples.  

The BCI 50-ha plot includes some topographic variation, and can be divided into distinct habitats based on slope and elevation, with an additional separation of a small patch of younger forest in the north central part of the plot [@Harms2001;@Harms2023]. These topographically-defined habitats differ systematically in biomass and woody productivity [@Chave2003; Figure \@ref(fig:spatial), Table S2]. The slope habitat has the highest estimated biomass pare area (274 ± 15 Mg/ha) while the swamp has the highest estimated woody productivity flux (9.2 ± 2.4 Mg/ha/yr). Conversely, young forest has the lowest estimated biomass (193 ± 18 Mg/ha) and woody productivity (6.4 ± 1.0 Mg/ha). These differences among habitats, combined with the large-scale spatial structure of habitats within the plot, can explain why variation among 1-ha and larger subplots is larger than expected based on variation among smaller subplots [@Rejou-Mechain2014].  

### Temporal variation 

Productivity and mortality fluxes varied significantly among census intervals in the BCI 50-ha plot, yet biomass stocks have remained relatively constant between 1985 and 2015 [Figure \@ref(fig:temporal); @Chave2003; @Feeley2007; @Chave2008; @Muller-Landau2014; @Cushman2014; @Meakem2018; @Rutishauser2020]. The exact temporal patterns vary considerably depending on methodological details regarding allometric equations and approaches for dealing with changes in the point of measurement height and outlying growth records, especially for productivity (supplemental material), leading to differences in results among studies.  Because tree measurement points were moved substantially upwards on many trees from 1985 to 1990, the estimated net flux for 1985-1990 is particularly sensitive; for example, it is significantly positive if a taper correction is applied, and slightly negative without one [Figure \@ref(fig:temporal)b; @Cushman2014]. 

Temporal variation in wood productivity and mortality has been explained in part by the effects of climate on tree growth and mortality, although making such links is challenging given the five-year census intervals. Both growth and mortality rates were elevated during 1982-1985, especially for larger trees; this interval included a major drought associated with a strong El Niño event [@Condit1995;@Feeley2007a;@Condit2017;@Meakem2018]. Most studies do not attempt to calculate biomass stocks or fluxes for the first census (1982) and first census interval, because all trees including buttressed trees were measured in diameter at 1.3 m in the first census, but the one study that does so estimates both productivity and mortality fluxes were highest in this census interval [@Meakem2018].  Growth rates and woody productivity were also elevated in the following census interval of 1985-1990 relative to later intervals [@Chave2003;@Condit2017;@Meakem2018;@Rutishauser2020]. @Feeley2007a and @Dong2012 examine how temporal variation in growth on BCI (through 2005) and one or three (respectively) other large tropical plots relates to climate, both finding that growth was negatively correlated with mean daily minimum temperature and positively correlated with solar radiation among census intervals within sites. 

Testing for changes in growth, mortality and biomass within mature forests can be challenging because these forests are mosaics of areas in different stages of gap-phase regeneration (succession after canopy gap formation), and thus of areas with different forest structure, biomass, growth, and mortality. Several studies have taken advantage of the large size of the BCI 50-ha plot to test whether there have been changes over time in the distribution of gap dynamic stages, or of biomass dynamics for a given gap dynamic stage [@Feeley2007;@Muller-Landau2014;@Rutishauser2020]. Though differing in their methods and census intervals included, all these studies concluded that the distribution of gap dynamic stages has remained relatively constant across census intervals, and that biomass stocks and fluxes as a function of gap stage have shown no long-term directional trend across all census intervals. However, mortality rates and fluxes decreased from the initial censuses to 1990-1995, and have increased since [@Condit2017;@Meakem2018;@Rutishauser2020].  

### Contributions by size class, functional type, and species

Biomass is highly unequally distributed among trees of different sizes and species. These distributions affect the plot’s biomass fluxes, as trees of different sizes and functional traits have different growth and mortality rates, and respond differently to environmental variation. 

Intermediate diameter classes contained the greatest proportion of AGB: over half of the total live AGB was in trees 10-60 cm in diameter [@Chave2003]. Woody productivity fluxes also peak at intermediate diameter classes in BCI, but their value is relatively higher in small stems compared to AGB: stems ≥ 50 cm accounted for on average 59% of AGB, but only 45% of woody productivity [@Meakem2018]. The distribution of AGB stocks and fluxes among diameter classes varies little over time (Figure \@ref(fig:groups)a-c; Table S3). 

The distribution of biomass stocks and fluxes among species is highly uneven.  Just ten species contribute 41% of AGB, and the distribution of contributions to AWP is only somewhat less skewed (Table SX). Classifying species by the functional groups defined by @Ruger2020, we find that long-lived pioneers are the most important group, contributing an average of 43% of the AGB and 32% of woody productivity, with these proportions increase over time (Figure \@ref(fig:groups)c-e; Table S3). 

## The BCI 50-ha plot in a regional and global context 

Variation among sites in forest carbon stocks, productivity, and net flux is expected due to underlying heterogeneity. Tropical forests are highly heterogeneous in climate, soils, anthropogenic pressures, forest structure, and species composition, and these differences can all contribute to variation in their carbon stocks and fluxes, including biomass trajectories over recent decades. 

The BCI 50-ha plot is intermediate in climate, soils, biomass stocks, productivity, and mortality in comparison with other forest sites in central Panama [@Chave2004;@Muller-Landau2023]. Remote sensing studies suggest the forest structure and biomass of the 50-ha plot are fairly typical for old-growth forest in the central area of the island [@Mascaro2011], and its biomass, productivity and mortality are similar to those found in other old-growth plots on BCI, even though the plot is in the flattest, highest elevation part of the island [@Meakem2023].  

Compared with other old-growth tropical forest plots in Latin America included in @Sullivan2020, the BCI 50-ha plot is fairly typical in its values of biomass stocks, productivity, and mortality, and lower than most (23rd percentile) in biomass change (Figure \@ref(fig:global)).  The contrast between multiple high-profile studies reporting increasing biomass stocks in other plot-based studies of tropical forest [@Baker2004;@Lewis2009;@Sullivan2020] and the relatively stable biomass stocks on the BCI 50-ha plot over > 30 years has led many to ask if there is something different about BCI, in biology or methods.  However, a recent remote sensing study finds that intact moist tropical forests in South America were on average approximately carbon neutral between 2000 and 2019 (@Xu2021).  Specifically, 18% of the area was estimated to be gaining carbon at a rate of 0.19 Mg C ha$^{-1}$ yr$^{-1}$, 20% losing carbon at a rate of 0.18 Mg C ha$^{-1}$ yr$^{-1}$, and the remaining area had no significant trend. This suggests that, far from being an outlier, BCI is similar to the median intact moist tropical forests of South America in the relative stability of its forest carbon stocks. Differences in environmental conditions, global change forcings, and floristics between BCI and the median Latin American tropical forests are discussed in @Wright2023.

## Conclusions and future directions 

The 50 ha plot tree censuses have greatly improved our knowledge of tropical forest biomass stocks and dynamics, as well as the underlying processes driving spatial and temporal variation in tree growth and mortality. They have led to a better understanding of the multiple sources of uncertainty in estimating woody biomass stocks and fluxes. Although woody biomass fluxes varied among censuses, including in relation to El Niño events, there were no long-term directional changes in woody biomass stocks.  However, there are still critical gaps in this knowledge, particularly with respect to temporal variation in biomass fluxes in relation to climate variation and global change, and the degree to which estimates of biomass stocks and fluxes based on allometric equations capture true patterns of variation. 

The five-year census interval length for the complete tree censuses on the 50 ha BCI plot limits the ability to investigate temporal variation in woody productivity and mortality, as these intervals average over annual and intra-annual variation, and provide few data points for links to climate. Annual censuses of subsets of trees for mortality and damage [@Arellano2021;@Zuleta2022], and for diameter growth with dendrometers [@Ramos2022] now provide higher temporal resolution data for quantifying temporal and testing associated hypotheses. Monthly drone flights over the 50-ha plot since October 2014 provide even higher temporal resolution data on canopy disturbance, including treefalls, branchfalls, and standing dead trees [@Araujo2021].  

Estimates of biomass stocks and fluxes on the 50-ha plot to date all rely on generalized allometric equations, which have large errors on individual trees and systematic errors across sites, species, and tree condition, including liana infestation. A key question is the degree to which these indirect methods correctly capture spatial and temporal variation in biomass stocks and fluxes, especially considering increasing liana abundance and infestation [@Wright2004;@Ingwell2010;@Schnitzer2021] and changes in tree species composition [@Katabuchi2017]. Further, standard estimates of biomass loss fluxes ignore branchfalls, which are an important part of aboveground biomass turnover in tropical forests and account for about a fourth of the area of canopy gaps in BCI [@Araujo2021].  Terrestrial laser scanning can provide nondestructive measurements of stem and branch volume, which greatly increases the precision of forest biomass estimates, and capture local variation in biomass allometries [@Disney2019]. Repeat terrestrial and/or drone-based laser scanning now provides the means to more directly measure aboveground woody stocks and fluxes, including those associated with branchfalls, and the collection of such datasets should be a high priority for future research.  



**Acknowledgements**

**Author Contributions**

## Figures

```{r temporal, fig.height=6, fig.width=6, fig.cap = "Aboveground biomass stocks and fluxes in the 50-ha BCI plot. (a) Aboveground biomass (AGB, Mg/ha) by census; (b) changes in aboveground biomass stocks ($\\Delta$AGB, Mg/ha/yr), by census interval; (c) aboveground biomass fluxes (Mg/ha/yr), by census interval: aboveground woody productivity (AWP) in blue and aboveground woody mortality (AWM) in red. Points represent the total plot value, and segments represent the 95% confidence interval obtained by bootstrapping over 20 x 20m quadrats. Individual stem AGB values were obtained using the equation from Chave et al., 2014, using local tree allometry from Martínez Cano et al., 2019; no corrections were applied. Exact values are also found in Table S1."}
# prepare data for the figure
dfig <- subset(df_plot, (variable =="gain" & method == "chave14_h+subs+kohyama") |
                 (variable =="loss" & method == "chave14_h+kohyama") |
                 (variable %in% c("stock", "delta") & method == "chave14_h")|
                 (variable == "delta" & method == "chave14_h+taper"))

dfig[, taper := grepl("taper", method)]

# intermediate census years for agb fluxes
dfig[variable != "stock", year := year + 2.5]
dfig[variable == "gain", year := year - 0.05]
dfig[variable == "loss", year := year + 0.05]
dfig[variable == "dagb" & !taper, year := year - 0.05]
dfig[variable == "dagb" & taper, year := year + 0.05]

dfig$var_group <- as.character(dfig$variable)
dfig$var_group[dfig$variable %in% c("gain", "loss")] <- "flux"

dfig$variable <- factor(dfig$variable, levels = c("stock", "delta", "gain", "loss"))
levels(dfig$variable) <- c("AGB","DAGB","AWP","AWM")
# levels(dfig$variable)[grep("DAGB", levels(dfig$variable))] <- c("No taper correction", "Taper correction")

dfig$var_group <- factor(dfig$var_group, levels = c("stock", "delta", "flux"))
levels(dfig$var_group) <- c("'AGB (Mg/ha)'", "Delta*'AGB (Mg/ha/yr)'", "'AWP or AWM (Mg/ha/yr)'")

## panel labels
ann_panels <- data.frame(text = letters[1:3], var_group = factor(levels(dfig$var_group), levels = levels(dfig$var_group)))

## horizontal line
ann_line <- data.frame(line = 0, var_group = factor(levels(dfig$var_group)[2], levels = levels(dfig$var_group)))

ggplot2::ggplot(dfig, ggplot2::aes(x = year, y = tot)) +
  ggplot2::geom_pointrange(ggplot2::aes(ymin = lwr, ymax = upr, color = variable, alpha = taper)) +
  ggplot2::labs(x = "", y = "", color = " \n \n \n \n \n", alpha = "Taper corrected") +
  ggplot2::geom_text(data = ann_panels, aes(label = text), x = -Inf, y = Inf, hjust = 5, vjust = 0.5, size = 5) +
  ggplot2::geom_hline(data = ann_line, aes(yintercept = line), lty = 2) + ## add horizontal line to delta AGB
  ggplot2::theme_classic() +
  ggplot2::coord_cartesian(clip = "off") +  # allow text to be written outside the plot (panel labels)
  ggplot2::scale_alpha_manual(values = c(1, 0.3), labels = c("No", "Yes")) + 
  ggplot2::scale_color_discrete(breaks = c("AWP", "AWM"), type = c("black", "black", "cyan4", "coral2")) +
  ggplot2::theme(strip.placement = "outside",
                 strip.background = element_blank(),
                 legend.background = element_rect(fill='transparent'),
                 legend.position = c(0.9, 0.45),
                 legend.title = element_text(size=8), #change legend title font size
                 legend.text = element_text(size=8),
                 plot.title = ggplot2::element_text(hjust = 0.5, vjust = 2, size = 15)) +
  ggplot2::facet_wrap(~var_group, scales = "free_y", strip.position = "left", ncol=1, labeller = label_parsed)+
  ggplot2::guides(color = guide_legend(order=2), alpha = guide_legend(order = 1))
```


```{r spatial, fig.height=7, fig.width=6, fig.cap = "Spatial variation in (a) aboveground biomass (AGB, Mg/ha) and (b) aboveground woody productivity (AWP, Mg/ha) among habitats, as defined by Harms et al., 2001; panel (c) shows the location of habitats in the 50-ha plot. Points represent the total plot value, averaged over censuses and census intervals (starting in 1995), and segments represent the 95% confidence interval obtained by bootstrapping over 20x20m quadrats. The horizontal lines represent the total value of the plot. AGB and AWP values for habitats, as well as aboveground woody mortality (AWM) and changes in AGB between censuses, are provided in Table S2."}

# change habitat names to match Harms et al 2001
levels(bci_habitat$habitat) <- paste0(toupper(substr(levels(bci_habitat$habitat), 1, 1)), 
                                      substr(levels(bci_habitat$habitat), 2, nchar(levels(bci_habitat$habitat))))
levels(bci_habitat$habitat) <- gsub("Hi_", "High ", levels(bci_habitat$habitat))
levels(bci_habitat$habitat) <- gsub("_", " ", levels(bci_habitat$habitat))
levels(bci_habitat$habitat) <- gsub("Young", "Young forest", levels(bci_habitat$habitat))

# ## Convert bci_habitat to a raster 
bci_habitat[, `:=`(xr = x + 10, yr = y + 10)]
ghabitat <- ggplot(bci_habitat) +
  geom_raster(aes(x = xr, y = yr, fill = habitat)) + 
  labs(x = "", y = "", fill = "") +
  expand_limits(x = c(0, 1000), y = c(0, 500)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = RColorBrewer::brewer.pal(7, "Dark2")[c(1, 5, 3, 6, 4, 2, 7)]) +
  coord_equal() +
  theme_bw()

# prepare data for the figure
dfig <- df_hab[variable %in% c("stock", "gain")]
# intermediate census years for agb fluxes
dfig[variable != "stock", year := year + 2.5]
# dfig[variable == "awp", year := year - 0.05]
# dfig[variable == "awm", year := year + 0.05]

dfig$variable <- factor(dfig$variable, levels = c("stock", "gain"))
levels(dfig$variable) <- c("'AGB (Mg/ha)'", 
                           "'AWP (Mg/ha/yr)'")

# change habitat names to match Harms et al 2001
levels(dfig$habitat) <- paste0(toupper(substr(levels(dfig$habitat), 1, 1)), 
                               substr(levels(dfig$habitat), 2, nchar(levels(dfig$habitat))))
levels(dfig$habitat) <- gsub("Hi_", "High ", levels(dfig$habitat))
levels(dfig$habitat) <- gsub("_", " ", levels(dfig$habitat))
levels(dfig$habitat) <- gsub("Young", "Young forest", levels(dfig$habitat))


## average over census years
dfig <- dfig[year > 1990, .(tot = mean(tot), lwr = mean(lwr),  upr = mean(upr)), .(habitat, variable)]

## panel labels
ann_panels <- data.frame(text = letters[1:2], variable = factor(levels(dfig$variable), levels = levels(dfig$variable)))

plot_agb <- df_plot[method=="chave14_h+subs" & variable=="stock" & year > 1990, 
                    .(tot = mean(tot), lwr = mean(lwr), upr = mean(upr))]
plot_awp <- df_plot[method=="chave14_h+subs+kohyama" & variable=="gain" & year > 1990, 
                     .(tot = mean(tot), lwr = mean(lwr), upr = mean(upr))]

df_hline <- data.frame(plot_tot = c(plot_agb$tot, plot_awp$tot), 
                       variable = factor(levels(dfig$variable), levels = levels(dfig$variable)))
                                         
g1 <- ggplot2::ggplot(dfig, ggplot2::aes(x = habitat, y = tot)) +
  geom_hline(data = df_hline, aes(yintercept = plot_tot), lty = 2) +
  ggplot2::geom_pointrange(ggplot2::aes(ymin = lwr, ymax = upr, color = habitat)) +
  ggplot2::labs(x = "", y = "", color = "") +
  ggplot2::geom_text(data = ann_panels, aes(label = text), x = -Inf, y = Inf, hjust = 5, vjust = 0.5, size = 5) +
  ggplot2::theme_classic() +
  ggplot2::coord_cartesian(clip = "off") +  # allow text to be written outside the plot (panel labels)
  ggplot2::theme(strip.placement = "outside",
                 strip.background = element_blank(),
                 plot.title = ggplot2::element_text(hjust = 0.5, vjust = 2, size = 15),
                 axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), 
                 legend.position = "none") +
  scale_color_manual(values = RColorBrewer::brewer.pal(7, "Dark2")[c(1, 5, 3, 6, 4, 2, 7)]) +
  ggplot2::facet_wrap(~variable, scales = "free_y", strip.position = "left", ncol=1, labeller = label_parsed)

ggpubr::ggarrange(g1, ghabitat, ncol=1, labels = c("", "c"), heights = c(2,1))
```

```{r groups, fig.height=6, fig.width=10, fig.cap = "Contribution by diameter class (a-c) and functional group (d-f) to aboveground biomass (AGB, Mg/ha), aboveground woody productivity (AWP, Mg/ha/yr)  and aboveground woody mortality (AWM, Mg/ha/yr).  AGB, AWP, AWM values and inter-census changes in AGB by size class and functional group are provided in Table S3."}
# change flux year to match middle of census interval
df_size[variable != "agb", year := year + 2.5]

# change variable labels (AGB, AWP) to upper case
df_size$variable <- factor(df_size$variable, levels = c("stock", "gain", "loss"))
levels(df_size$variable) <- c("AGB (Mg/ha)", "AWP (Mg/ha/yr)", "AWM (Mg/ha/yr)")

# revert order of size classes to have bigger trees above
df_size$size <- factor(df_size$size, levels = rev(levels(df_size$size)))

## panel labels
ann_panels <- data.frame(text = letters[1:3], 
                         h = c(4, 3, 4), v = 0.5,
                         variable = factor(levels(df_size$variable), 
                                           levels = levels(df_size$variable)))

fig3a_bis_groups_size <- ggplot(df_size) + 
  geom_col(aes(x = year, y = tot, fill = size)) + 
  ggplot2::geom_text(data = ann_panels, aes(label = text, hjust = h, vjust = v), x = -Inf, y = Inf, size = 5) +
  ggplot2::coord_cartesian(clip = "off") +  # allow text to be written outside the plot (panel labels)
  labs(x = "", y = "", fill = "Diameter\nclass (cm)") +
  scale_y_continuous(expand = c(0, 0)) +  
  scale_fill_brewer(palette = "RdYlBu") +
  ggplot2::theme_classic() +
  ggplot2::theme(strip.placement = "outside", 
                 strip.background = element_blank(), 
                 plot.title = ggplot2::element_text(hjust = 0.5, vjust = 2, size = 15)) +
  ggplot2::facet_wrap(~variable, scales = "free", strip.position = "left")

# b - PFT according to Ruger et al 2020

# change flux year to match middle of census interval
df_pft[variable != "agb", year := year + 2.5]

df_pft$variable <- factor(df_pft$variable, levels = c("stock", "gain", "loss"))
levels(df_pft$variable) <- c("AGB (Mg/ha)", "AWP (Mg/ha/yr)", "AWM (Mg/ha/yr)")

## panel labels
ann_panels <- data.frame(text = letters[4:6], 
                         h = c(4, 3, 5), v = 0.5,
                         variable = factor(levels(df_pft$variable), 
                                           levels = levels(df_pft$variable)))

# order and rename PFT 
df_pft$PFT[is.na(df_pft$PFT)] <- "NA"
df_pft$PFT <- factor(df_pft$PFT, levels = c("slow", "fast", "LLP", "SLB", "intermediate", "NA"))
levels(df_pft$PFT) <- list("Slow" = "slow", "Fast" = "fast", 
                           "Long-lived pioneers" = "LLP", 
                           "Short-lived breeders" = "SLB", 
                           "Intermediate" = "intermediate", 
                           "No value" = "NA")

fig3b_bis_groups_pft <- ggplot(df_pft) + 
  geom_col(aes(x = year, y = tot, fill = PFT)) + 
  ggplot2::geom_text(data = ann_panels, aes(label = text, hjust = h, vjust = v), x = -Inf, y = Inf, size = 5) +
  ggplot2::coord_cartesian(clip = "off") +  # allow text to be written outside the plot (panel labels)
  labs(x = "", y = "", fill = "PFT \n(Ruger et al., 2020)") +
  scale_y_continuous(expand = c(0, 0)) +  
  scale_fill_manual(values = c("orchid", "gold", "seagreen", "royalblue", "darkorange", "grey")) +
  theme_classic() +
  ggplot2::theme(strip.placement = "outside", 
                 strip.background = element_blank(), 
                 plot.title = ggplot2::element_text(hjust = 0.5, vjust = 2, size = 15)) +
  ggplot2::facet_wrap(~variable, scales = "free", strip.position = "left")

# c - PFT according to Rubio et al 2022

# change flux year to match middle of census interval
df_pft2[variable != "agb", year := year + 2.5]

# change variable labels (AGB, AWP) to upper case
levels(df_pft2$variable) <- c("AGB (Mg/ha)", "AWP (Mg/ha/yr)", "AWM (Mg/ha/yr)")

# order and rename PFT 
df_pft2$FG[is.na(df_pft2$FG)] <- "NA"
df_pft2$FG <- factor(df_pft2$FG, levels = c("1", "2", "3", "NA"))
levels(df_pft2$FG) <- list("Short shade-tolerants" = "1", 
                           "Tall shade-tolerants" = "2", 
                           "Tall pioneers" = "3",
                           "No value" = "NA")
## panel labels
ann_panels <- data.frame(text = letters[7:9], 
                         h = c(4, 3, 7), v = 0.5,
                         variable = factor(levels(df_pft2$variable), 
                                           levels = levels(df_pft2$variable)))

fig3c_bis_groups_pft2 <- ggplot(df_pft2) + 
  geom_col(aes(x = year, y = tot, fill = FG)) + 
  ggplot2::geom_text(data = ann_panels, aes(label = text, hjust = h, vjust = v), x = -Inf, y = Inf, size = 5) +
  ggplot2::coord_cartesian(clip = "off") +  # allow text to be written outside the plot (panel labels)
  labs(x = "", y = "", fill = "FG \n(Rubio & Swenson, 2022)") +
  scale_y_continuous(expand = c(0, 0)) +  
  scale_fill_manual(values = c("#E41A1C", "#377EB8", "#4DAF4A", "grey")) +
  theme_classic() +
  ggplot2::theme(strip.placement = "outside", 
                 strip.background = element_blank(), 
                 plot.title = ggplot2::element_text(hjust = 0.5, vjust = 2, size = 15)) +
  ggplot2::facet_wrap(~variable, scales = "free", strip.position = "left")

fig3a_leg <- ggpubr::as_ggplot(ggpubr::get_legend(fig3a_bis_groups_size))
fig3b_leg <- ggpubr::as_ggplot(ggpubr::get_legend(fig3b_bis_groups_pft))
fig3c_leg <- ggpubr::as_ggplot(ggpubr::get_legend(fig3c_bis_groups_pft2))

ggpubr::ggarrange(fig3a_bis_groups_size + theme(legend.position = "none"), fig3a_leg,
                  fig3b_bis_groups_pft + theme(legend.position = "none"), fig3b_leg,
                  # fig3c_bis_groups_pft2 + theme(legend.position = "none"), fig3c_leg,
                  ncol = 2, nrow = 2, widths = c(4,1))
```

```{r global, fig.height=6, fig.width=8, fig.cap = "Density plots of distributions of aboveground biomass (AGB, Mg/ha), changes in AGB ($\\Delta$AGB, Mg/ha/yr), aboveground woody productivity (AWP, Mg/ha/yr), and aboveground woody mortality (AWM, Mg/ha/yr) in mature tropical forests on four continents: Africa (AF), Asia (AS), Australia (AU), and South America (SA); data are from Sullivan et al. , 2020. Mean values for BCI are indicated by red vertical lines."}

if (!dir.exists("MSullivan2020")) {
  # download data from Sullivan et al 2020
  sullivan_url <- "https://forestplots.net/upload/data-packages/sullivan-et-al-2020/MSullivan2020.zip"
  download.file(sullivan_url, destfile = "MSullivan2020.zip", mode = "wb")
  
  # unzip
  utils::unzip("MSullivan2020.zip", exdir = "MSullivan2020")
}

sullivan_mul <- read.csv("MSullivan2020/Data package/MultiCensusPlots.csv")
sullivan_all <- read.csv("MSullivan2020/Data package/AllPlots.csv")

df_mean <- df_plot[year > 1990 & method=="chave14_h_dbh10+kohyama", 
                   .(value = mean(tot)), .(variable)]
df_mean <- data.table::dcast(df_mean, .~variable)

sagb <- ggplot(sullivan_all, aes(x = AGB)) + 
  geom_density(alpha = 0.5, aes(fill = Continent)) +
  geom_vline(col=2, xintercept = df_mean$stock) +
  annotate(geom = "text", col = 2, label = "BCI", x = df_mean$agb*1.25, y = 0, vjust = -1) +
  labs(x = "AGB (Mg/ha)", y = "") +
  expand_limits(x = 0) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_classic() +
  theme(legend.position = c(0.85, 0.75))

sawp <- ggplot(sullivan_mul, aes(x = AGWP)) + 
  geom_density(alpha = 0.5, aes(fill = Continent)) +
  geom_vline(col=2, xintercept = df_mean$gain) +
  annotate(geom = "text", col = 2, label = "BCI", x = df_mean$awp*0.9, y = 0, vjust = -1) +
  labs(x = "AWP (Mg/ha/yr)", y = "") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_classic() +
  theme(legend.position = "none")

sawm <- ggplot(subset(sullivan_mul, Mort < 22), aes(x = Mort)) + 
  geom_density(alpha = 0.5, aes(fill = Continent)) +
  geom_vline(col=2, xintercept = df_mean$loss) +
  annotate(geom = "text", col = 2, label = "BCI", x = df_mean$awm*0.8, y = 0, vjust = -1) +
  labs(x = "AWM (Mg/ha/yr)", y = "") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_classic() +
  theme(legend.position = "none")

sdagb <- ggplot(subset(sullivan_mul, Mort < 20), aes(x = AGWP-Mort)) + 
  geom_density(alpha = 0.5, aes(fill = Continent)) +
  geom_vline(col=2, xintercept = df_mean$delta) +
  annotate(geom = "text", col = 2, label = "BCI", x = (df_mean$dagb)+2, y = 0, vjust = -1) +
  labs(x = bquote(Delta*'AGB (Mg/ha/yr)'), y = "") +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  theme_classic() +
  theme(legend.position = "none")

ggpubr::ggarrange(sagb, sdagb, sawp,sawm, ncol=2, nrow = 2, labels = "auto")

## quantiles of BCI's values
# global
round(ecdf(sullivan_mul$AGWP-sullivan_mul$Mort)(df_mean$delta)*100)
round(ecdf((sullivan_mul$AGWP-sullivan_mul$Mort)[sullivan_mul$Continent == "SA"])(df_mean$delta)*100)

quantile((sullivan_mul$AGWP-sullivan_mul$Mort)[sullivan_mul$Continent == "SA"], 0.22, na.rm = T)
```

## Supplemental tables

Table SXX - Total above-ground woody biomass (AGB; Mg/ha), above-ground biomass change (deltaAGB; Mg/ha/yr), above-ground woody productivity (AWP; Mg/ha/yr), above-ground woody mortality (AWM; Mg/ha/yr), basal area (BA; m$^2$/ha/ha), basal area change (deltaBA ; m$^2$/ha/yr), basal area productivity (BAP; m$^2$/ha/yr), basal area mortality (BAM; Mg/ha/yr), number of trees (N; /ha), change in number of trees (deltaN; /ha/yr), number of trees with a diameter $\geq$ 10 cm (N10; /ha), change in number of trees with a diameter $\geq$ 10 cm (deltaN10; /ha/yr). Above-ground biomass was estimated using the allometry of @Chave2014 with the generalized local height allometry of @MartinezCano2019. The following corrections were applied where meaningful: the 'Taper correction' of @Cushman2014; the 'Kohyama correction' for instantaneous fluxes [@Kohyama2019]; and the 'Outlier substitution' for trees with excessive change in diameter and/or height measurement (see Methods). We provide values over the entire plot and the lower and upper limits of the 95% confidence interval (in parentheses), estimated after bootstrapping 20 x 20 m quadrats with 1000 replicates.

```{r supp-table-qaqc}
load("cache.rda")

dtab <- df_plot[!(grepl("chave05|dbh10", method) | method=="chave14")]

dtab[, type := variable]

dtab[, variable := tstrsplit(gsub("chave14_h", "agb", dtab$method), "\\+")[[1]]]

# set of corrections
dtab[,  correction := gsub("chave14_h\\+|ba\\+", "", method)]

dtab[grep("n|ba|chave", correction), correction := "No correction"]

dtab[, correction := gsub("taper", "taper correction", correction)]
dtab[, correction := gsub("subs", "outlier substitution", correction)]
dtab[, correction := gsub("kohyama", "Kohyama", correction)]
dtab[, correction := gsub("\\+", "; ", correction)]

# value and 95% CI
dtab[, value := paste0(signif(tot, 3), " (", signif(lwr, 3), "-", signif(upr, 3), ")")]

dtab <- data.table::dcast(dtab, year + correction ~ variable + type, value.var = "value")

dtab$interval <- c(paste(dtab$year-5, dtab$year, sep = " - ")[-1], NA)

colnames(dtab) <- c("Census year", "correction", 
                    "AWP", "AWM", "AGB", "deltaAGB", 
                    "BAP", "BAM", "BA", "deltaBA",
                    "N", "deltaN", "N10", "deltaN10",
                    "Census interval") 

dtab[, `Taper correction` := c("No", "Yes")[1+grepl("taper", correction)]]
dtab[, `Kohyama correction` := c("No", "Yes")[1+grepl("ohyama", correction)]]
dtab[, `Outlier substitution` := c("No", "Yes")[1+grepl("subs", correction)]]

dtab <- dtab[ , c("Census year", "Census interval", 
                  "Taper correction", "Kohyama correction", "Outlier substitution", 
                  "AGB", "deltaAGB", "AWP", "AWM", 
                  "BA", "deltaBA", "BAP", "BAM", 
                    "N", "deltaN", "N10", "deltaN10")]

setorder(dtab, `Taper correction`, `Kohyama correction`, `Outlier substitution`, 
         `Census year`, `Census interval`)

write.csv(dtab, file = "stables/table-qaqc.csv", row.names = FALSE)
```

Table SXX - Total above-ground woody biomass (AGB; Mg/ha), above-ground biomass change ($\Delta$AGB; Mg/ha/yr), above-ground woody productivity (AWP; Mg/ha/yr), and above-ground woody mortality (AWM; Mg/ha/yr) per habitat (as defined in Harms et al., 2001). Above-ground biomass was estimated using the allometry of @Chave2014 with the generalized local height allometry of @MartinezCano2019. The 'Kohyama correction' for instantaneous fluxes (Kohyama et al., 2019) and the 'Outlier substitution' for trees with excessive change in diameter and/or height measurement (see Methods) were applied. We provide values over the entire plot and the lower and upper limits of the 95% confidence interval (in parentheses), estimated after bootstrapping 20 x 20 m quadrats with 1000 replicates.

```{r supp-table-habitats}
dtab <- df_crown_hab

# change name of habitat to match publication: first letter in upper case and add spaces
levels(dtab$habitat) <- paste0(toupper(substr(levels(dtab$habitat), 1, 1)), 
                                      substr(levels(dtab$habitat), 2, nchar(levels(dtab$habitat))))
levels(dtab$habitat) <- gsub("Hi_", "High ", levels(dtab$habitat))
levels(dtab$habitat) <- gsub("_", " ", levels(dtab$habitat))
levels(dtab$habitat) <- gsub("Young", "Young forest", levels(dtab$habitat))

dtab[, value := paste0(signif(tot, 3), " (", signif(lwr, 3), "-", signif(upr, 3), ")")]

dtab <- data.table::dcast(dtab, habitat + year ~ variable, value.var = "value")

dtab$interval<- c(paste(dtab$year-5, dtab$year, sep = " - ")[-1], NA)

dtab <- dtab[, c("habitat", "year", "interval", "agb", "dagb", "awp", "awm")]

colnames(dtab) <- c("Habitat", "Census year", "Census interval", "AGB", "deltaAGB", "AWP", "AWM")

write.csv(dtab, file = "stables/table-habitat.csv", row.names = FALSE)
```

Table SXX - Total above-ground woody biomass (AGB; Mg/ha), above-ground biomass change (deltaAGB; Mg/ha/yr), above-ground woody productivity (AWP; Mg/ha/yr), and above-ground woody mortality (AWM; Mg/ha/yr) per size class. Above-ground biomass was estimated using the allometry of @Chave2014 with the generalized local height allometry of Martinez Cano et al. (2019). The 'Kohyama correction' for instantaneous fluxes (Kohyama et al., 2019) and the 'Outlier substitution' for trees with excessive change in diameter and/or height measurement (see Methods) were applied. We provide values over the entire plot and the lower and upper limits of the 95% confidence interval (in parentheses), estimated after bootstrapping 20 x 20 m quadrats with 1000 replicates.

```{r supp-table-size}
dtab <- df_size

dtab[, value := paste0(signif(tot, 3), " (", signif(lwr, 3), "-", signif(upr, 3), ")")]

dtab <- data.table::dcast(dtab, size + year ~ variable, value.var = "value")

dtab$interval<- c(paste(dtab$year-5, dtab$year, sep = " - ")[-1], NA)

dtab <- dtab[, c("size", "year", "interval", "stock", "gain", "loss")]

colnames(dtab) <- c("Size class (cm)", "Census year", "Census interval", "AGB", "AWP", "AWM")

write.csv(dtab, file = "stables/table-size.csv", row.names = FALSE)
```

Table SXX - Total above-ground woody biomass (AGB; Mg/ha), above-ground biomass change (deltaAGB; Mg/ha/yr), above-ground woody productivity (AWP; Mg/ha/yr), and above-ground woody mortality (AWM; Mg/ha/yr) per plant functional type, as defined in Rüger et al. (2020). Above-ground biomass was estimated using the allometry of @Chave2014 with the generalized local height allometry of Martinez Cano et al. (2019). The 'Kohyama correction' for instantaneous fluxes (Kohyama et al., 2019) and the 'Outlier substitution' for trees with excessive change in diameter and/or height measurement (see Methods) were applied. We provide values over the entire plot and the lower and upper limits of the 95% confidence interval (in parentheses), estimated after bootstrapping 20 x 20 m quadrats with 1000 replicates.

```{r supp-table-pft}
dtab <- df_pft

dtab[, value := paste0(signif(tot, 3), " (", signif(lwr, 3), "-", signif(upr, 3), ")")]

dtab <- data.table::dcast(dtab, PFT + year ~ variable, value.var = "value")

dtab$interval<- c(paste(dtab$year-5, dtab$year, sep = " - ")[-1], NA)

dtab <- dtab[, c("PFT", "year", "interval", "stock", "gain", "loss")]

colnames(dtab) <- c("PFT", "Census year", "Census interval", "AGB", "AWP", "AWM")

write.csv(dtab, file = "stables/table-pft.csv", row.names = FALSE)
```


Table SXX - Species total above-ground woody biomass (AGB; Mg/ha), above-ground woody productivity (AWP; Mg/ha/yr), above-ground woody mortality (AWM; Mg/ha/yr), basal area (BA; m$^2$/ha/ha), basal area productivity (BAP; m$^2$/ha/yr), basal area mortality (BAM; Mg/ha/yr), number of trees (N; /ha), and number of trees with a diameter $\geq$ 10 cm (N10; /ha). Above-ground biomass was estimated using the allometry of @Chave2014 with the generalized local height allometry of Martinez et al. (2019); aboveground woody productivity and basal area productivity were corrected by substituting outliers; we used the Kohyama et al. (2019) correction to estimate instantaneous AGB and BA fluxes. We provide values over the entire plot and the lower and upper limits of the 95% confidence interval (in parentheses), estimated after bootstrapping 20 x 20 m quadrats with 1000 replicates.

```{r supp-table-species}
dtab <- df_species

# get species names
dryad_data_path <- rdryad::dryad_download("10.15146/5xcp-0d46")
load(grep("spp", dryad_data_path$`10.15146/5xcp-0d46`, value = TRUE))
dtab <- merge(dtab, bci.spptable[, c("sp", "Latin")], by = "sp", all.x = TRUE) 

dtab[, value := paste0(signif(tot, 3), " (", signif(lwr, 3), "-", signif(upr, 3), ")")]

dtab[, type := variable]

dtab[, variable := factor(method, levels = c("chave14_h+subs", "ba+subs", "n", "n10"))]
levels(dtab$variable) <- c("AGB", "BA", "N", "N10")


dtab <- data.table::dcast(dtab, Latin + year ~ variable + type, value.var = "value")

dtab$interval<- c(paste(dtab$year-5, dtab$year, sep = " - ")[-1], NA)

colnames(dtab) <- c("Species", "Census year",  
                    "AWP", "AWM", "AGB", 
                    "BAP", "BAM", "BA", 
                    "N", "N10",
                    "Census interval") 

dtab <- dtab[, c("Species", "Census year", "Census interval", "AGB", "AWP", "AWM","BA", "BAP", "BAM","N", "N10")]

write.csv(dtab, file = "stables/table-species.csv", row.names = FALSE)
```

Table SXX - Total above-ground woody biomass (AGB; Mg/ha) for the entire BCI 50-ha, as estimated with different biomass and height allometries. The two biomass allometries used were those of Chave et al. (2005) and @Chave2014, as specified in the column "Biomass allometry". 
We used biomass allometries without height information ("Local height allometry" = No) or using the generalized height equation of Martinez Cano et al. (2019) for BCI ("Local height allometry" = Yes). 
In the "AGB" column, we provide the estimated AGB value over the entire plot and the lower and upper limits of the 95% confidence interval (in parentheses), estimated after bootstrapping 20 x 20 m quadrats with 1000 replicates. 

```{r sup-table-allometries}
dtab <- df_plot[!grepl("\\+", method) & grepl("chave", method)]

dtab[, value := paste0(signif(tot, 3), " (", signif(lwr, 3), "-", signif(upr, 3), ")")]

dtab <- data.table::dcast(dtab, year + method ~ variable, value.var = "value")

dtab$interval <- c(paste(dtab$year-5, dtab$year, sep = " - ")[-1], NA)

colnames(dtab) <- c("Census year", "method", "AWP", "AWM", "AGB", "deltaAGB", "Census interval") 

dtab[, `Biomass allometry` := c("Chave et al., 2005", "Chave et al., 2014")[1+grepl("14", method)]]
dtab[, `Local height allometry` := c("No", "Yes")[1+grepl("_h", method)]]

dtab <- dtab[ , c("Biomass allometry", "Local height allometry", 
                  "Census year", "Census interval", 
                  "AGB")]

setorder(dtab, `Biomass allometry`, `Local height allometry`, `Census year`, `Census interval`)

write.csv(dtab, file = "stables/table-allometries.csv", row.names = FALSE)
```


Table Sxx - Total above-ground woody biomass (AGB; Mg/ha), variation in above-ground woody biomass (deltaAGB; Mg/ha/yr), above-ground woody productivity (AWP; Mg/ha/yr), above-ground woody mortality (AWM; Mg/ha/yr), with methods corresponding to Sullivan et al. (2020) for a global comparison. Only stems with diameters greater than 10 cm were included; we estimated AGB using the biomass equation of @Chave2014 with a local generalized height allometry (Martinez Cano et al., 2019); we used the correction of Kohyama et al. (2019) to estimate instantaneous fluxes of AGB and BA. We provide values over the entire plot and the lower and upper limits of the 95% confidence interval (in parentheses), estimated after bootstrapping 20 x 20 m quadrats with 1000 replicates.

```{r sup-table-globcomparison}
dtab <- df_plot[grepl("dbh10", method)]

dtab[, value := paste0(signif(tot, 3), " (", signif(lwr, 3), "-", signif(upr, 3), ")")]

dtab <- data.table::dcast(dtab, year + method ~ variable, value.var = "value")

dtab$interval <- c(paste(dtab$year-5, dtab$year, sep = " - ")[-1], NA)

colnames(dtab) <- c("Census year", "method", "AWP", "AWM", "AGB", "deltaAGB", "Census interval")

dtab <- dtab[ , c("Census year", "Census interval", "AGB", "deltaAGB", "AWP", "AWM")]

setorder(dtab, `Census year`, `Census interval`)

write.csv(dtab, file = "stables/table-globcomparison.csv", row.names = FALSE)
```


## References